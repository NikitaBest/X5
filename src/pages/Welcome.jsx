import { useNavigate } from 'react-router-dom'
import { useState } from 'react'
import { useUserData } from '../contexts/UserDataContext.jsx'
import PrimaryButton from '../components/PrimaryButton.jsx'
import Page from '../layout/Page.jsx'
import Header from '../layout/Header.jsx'
import ProgressBar from '../ui/ProgressBar.jsx'
import RadioCard from '../ui/RadioCard.jsx'
import './Welcome.css'

const GOAL_OPTIONS = [
  {
    value: 'sugar',
    label: 'Взять сахар под контроль',
    icon: (
      <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M0 4C0 1.79086 1.79086 0 4 0H44C46.2091 0 48 1.79086 48 4V44C48 46.2091 46.2091 48 44 48H4C1.79086 48 0 46.2091 0 44V4Z" fill="var(--radio-icon-bg, #F5F5F5)"/>
        <path d="M40.165 32.0825C40.2436 32.1773 40.3028 32.2866 40.3391 32.4043C40.3754 32.522 40.3882 32.6456 40.3768 32.7682C40.3653 32.8908 40.3298 33.01 40.2723 33.1189C40.2148 33.2278 40.1364 33.3242 40.0415 33.4028C37.4056 35.5903 35.0415 36.3716 32.8931 36.3716C30.0509 36.3716 27.5603 35.0184 25.2462 33.7622C21.1837 31.5559 17.6775 29.6513 12.5415 33.9184C12.3482 34.0772 12.0998 34.1526 11.8508 34.1281C11.6019 34.1036 11.3729 33.9813 11.2142 33.788C11.0555 33.5947 10.9801 33.3462 11.0045 33.0973C11.029 32.8484 11.1513 32.6193 11.3447 32.4606C17.4587 27.3903 22.0712 29.8966 26.14 32.1075C30.2087 34.3184 33.7087 36.2184 38.8447 31.9513C38.9399 31.8731 39.0497 31.8145 39.1676 31.7788C39.2856 31.7431 39.4094 31.731 39.532 31.7431C39.6547 31.7553 39.7737 31.7916 39.8823 31.8498C39.9909 31.908 40.087 31.9871 40.165 32.0825ZM38.8447 23.2059C33.7087 27.4669 30.2009 25.5606 26.14 23.3622C22.079 21.1638 17.4587 18.6388 11.3447 23.7106C11.153 23.8693 11.0322 24.0977 11.0089 24.3455C10.9856 24.5932 11.0617 24.8401 11.2204 25.0317C11.3792 25.2234 11.6075 25.3441 11.8553 25.3674C12.103 25.3907 12.3499 25.3147 12.5415 25.1559C17.6775 20.895 21.1853 22.7997 25.2462 24.9997C27.5603 26.2497 30.0509 27.6106 32.8931 27.6106C35.0478 27.6106 37.4056 26.8294 40.0415 24.6419C40.233 24.4832 40.3536 24.2549 40.3767 24.0073C40.3999 23.7597 40.3237 23.513 40.165 23.3216C40.0063 23.1301 39.778 23.0096 39.5304 22.9864C39.2828 22.9633 39.0361 23.0394 38.8447 23.1981V23.2059ZM12.5415 16.3997C17.6775 12.1388 21.1853 14.045 25.2462 16.2434C27.5681 17.5075 30.0509 18.8669 32.8931 18.8669C35.0478 18.8669 37.4056 18.0856 40.0415 15.8981C40.1363 15.8195 40.2147 15.7231 40.2722 15.6142C40.3297 15.5053 40.3652 15.3861 40.3767 15.2635C40.3882 15.1409 40.3754 15.0173 40.339 14.8996C40.3027 14.782 40.2436 14.6726 40.165 14.5778C40.0864 14.483 39.9899 14.4046 39.881 14.3471C39.7721 14.2896 39.653 14.2541 39.5304 14.2427C39.4078 14.2312 39.2841 14.244 39.1665 14.2803C39.0488 14.3166 38.9395 14.3758 38.8447 14.4544C33.7087 18.7153 30.2009 16.8091 26.14 14.6106C22.079 12.4122 17.4587 9.88563 11.3447 14.9606C11.1532 15.1193 11.0326 15.3476 11.0095 15.5952C10.9863 15.8428 11.0625 16.0895 11.2212 16.2809C11.3799 16.4724 11.6082 16.593 11.8558 16.6161C12.1034 16.6393 12.3501 16.5631 12.5415 16.4044V16.3997Z" fill="currentColor"/>
      </svg>
    ),
  },
  {
    value: 'lightness',
    label: 'Обрести лёгкость',
    icon: (
      <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M0 4C0 1.79086 1.79086 0 4 0H44C46.2091 0 48 1.79086 48 4V44C48 46.2091 46.2091 48 44 48H4C1.79086 48 0 46.2091 0 44V4Z" fill="var(--radio-icon-bg, #F5F5F5)"/>
        <path d="M38.1668 7.33337H9.8335C9.17045 7.33337 8.53457 7.59677 8.06573 8.06561C7.59689 8.53445 7.3335 9.17033 7.3335 9.83337V38.1667C7.3335 38.8297 7.59689 39.4656 8.06573 39.9345C8.53457 40.4033 9.17045 40.6667 9.8335 40.6667H38.1668C38.8299 40.6667 39.4658 40.4033 39.9346 39.9345C40.4034 39.4656 40.6668 38.8297 40.6668 38.1667V9.83337C40.6668 9.17033 40.4034 8.53445 39.9346 8.06561C39.4658 7.59677 38.8299 7.33337 38.1668 7.33337Z" stroke="currentColor" strokeWidth="2.5" strokeLinejoin="round"/>
        <path d="M14 19.8784C16.7706 16.5451 20.1039 14.8784 24 14.8784C27.8956 14.8784 31.2289 16.5451 34 19.8784" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"/>
        <path d="M24 29.8334C24.663 29.8334 25.2989 29.57 25.7678 29.1011C26.2366 28.6323 26.5 27.9964 26.5 27.3334C26.5 26.6703 26.2366 26.0344 25.7678 25.5656C25.2989 25.0968 24.663 24.8334 24 24.8334C23.337 24.8334 22.7011 25.0968 22.2322 25.5656C21.7634 26.0344 21.5 26.6703 21.5 27.3334C21.5 27.9964 21.7634 28.6323 22.2322 29.1011C22.7011 29.57 23.337 29.8334 24 29.8334Z" fill="currentColor"/>
        <path d="M19.8335 21.5L24.0068 27.3333" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"/>
      </svg>
    ),
  },
  {
    value: 'energy',
    label: 'Получить заряд бодрости',
    icon: (
      <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M0 4C0 1.79086 1.79086 0 4 0H44C46.2091 0 48 1.79086 48 4V44C48 46.2091 46.2091 48 44 48H4C1.79086 48 0 46.2091 0 44V4Z" fill="var(--radio-icon-bg, #F5F5F5)"/>
        <path d="M14.3397 21.9276L24.8359 7.55398C25.6584 6.4304 27.1948 7.12908 27.1948 8.626V19.7516C27.1948 20.6494 27.7986 21.3747 28.5423 21.3747H33.6486C34.8089 21.3747 35.4266 23.0227 34.6601 24.0734L24.1639 38.4453C23.3414 39.5689 21.805 38.8702 21.805 37.3733V26.2477C21.805 25.3499 21.2012 24.6246 20.4575 24.6246H15.3494C14.1892 24.6246 13.5732 22.9765 14.3397 21.9276Z" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
      </svg>
    ),
  },
  {
    value: 'immunity',
    label: 'Укрепить иммунитет',
    icon: (
      <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M0 4C0 1.79086 1.79086 0 4 0H44C46.2091 0 48 1.79086 48 4V44C48 46.2091 46.2091 48 44 48H4C1.79086 48 0 46.2091 0 44V4Z" fill="var(--radio-icon-bg, #F5F5F5)"/>
        <path d="M39 22.3333C39 31.5833 32.6 40.2333 24 42.3333C15.4 40.2333 9 31.5833 9 22.3333V12.3333L24 5.66663L39 12.3333V22.3333ZM24 39C30.25 37.3333 35.6667 29.9 35.6667 22.7V14.5L24 9.29996L12.3333 14.5V22.7C12.3333 29.9 17.75 37.3333 24 39Z" fill="currentColor"/>
      </svg>
    ),
  },
  {
    value: 'shopping',
    label: 'Выгодно покупать полезное',
    icon: (
      <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M0 4C0 1.79086 1.79086 0 4 0H44C46.2091 0 48 1.79086 48 4V44C48 46.2091 46.2091 48 44 48H4C1.79086 48 0 46.2091 0 44V4Z" fill="var(--radio-icon-bg, #F5F5F5)"/>
        <path d="M19.8333 30.6667C16.8056 30.6667 14.2433 29.6178 12.1467 27.52C10.05 25.4222 9.00111 22.86 9 19.8333C8.99889 16.8067 10.0478 14.2444 12.1467 12.1467C14.2456 10.0489 16.8078 9 19.8333 9C22.8589 9 25.4217 10.0489 27.5217 12.1467C29.6217 14.2444 30.67 16.8067 30.6667 19.8333C30.6667 21.0556 30.4722 22.2083 30.0833 23.2917C29.6944 24.375 29.1667 25.3333 28.5 26.1667L37.8333 35.5C38.1389 35.8056 38.2917 36.1944 38.2917 36.6667C38.2917 37.1389 38.1389 37.5278 37.8333 37.8333C37.5278 38.1389 37.1389 38.2917 36.6667 38.2917C36.1944 38.2917 35.8056 38.1389 35.5 37.8333L26.1667 28.5C25.3333 29.1667 24.375 29.6944 23.2917 30.0833C22.2083 30.4722 21.0556 30.6667 19.8333 30.6667ZM19.8333 27.3333C21.9167 27.3333 23.6878 26.6044 25.1467 25.1467C26.6056 23.6889 27.3344 21.9178 27.3333 19.8333C27.3322 17.7489 26.6033 15.9783 25.1467 14.5217C23.69 13.065 21.9189 12.3356 19.8333 12.3333C17.7478 12.3311 15.9772 13.0606 14.5217 14.5217C13.0661 15.9828 12.3367 17.7533 12.3333 19.8333C12.33 21.9133 13.0594 23.6844 14.5217 25.1467C15.9839 26.6089 17.7544 27.3378 19.8333 27.3333Z" fill="currentColor"/>
      </svg>
    ),
  },
]

function Welcome() {
  const navigate = useNavigate()
  const { updateUserData } = useUserData()
  const [selectedGoals, setSelectedGoals] = useState([])

  const handleGoalToggle = (value) => {
    setSelectedGoals((prev) => {
      if (prev.includes(value)) {
        return prev.filter((goal) => goal !== value)
      } else if (prev.length < 2) {
        return [...prev, value]
      }
      return prev
    })
  }

  const handleNext = () => {
    // сохраняем выбранные цели в контекст пользователя
    updateUserData({ goals: selectedGoals })
    navigate('/recent-activity')
  }

  const selectedCount = selectedGoals.length
  const canProceed = selectedCount >= 1 && selectedCount <= 2

  return (
    <Page className="welcome-page">
      <Header title="Смарт анализ" showBack={false} />
      <ProgressBar currentStep={1} totalSteps={3} />
      
      <div className="welcome-content">
        <h1 className="welcome-heading">Что сейчас важнее?</h1>
        <p className="welcome-subtitle">
          Выберите 1-2 цели и мы подберём питание
        </p>

        <div className="welcome-goals">
          {GOAL_OPTIONS.map((option) => (
            <RadioCard
              key={option.value}
              icon={option.icon}
              label={option.label}
              value={option.value}
              selected={selectedGoals.includes(option.value)}
              onClick={handleGoalToggle}
            />
          ))}
        </div>
      </div>

      <div className="welcome-footer">
        {canProceed && (
          <div className="welcome-success-message">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M16.6667 5L7.50004 14.1667L3.33337 10" stroke="#5DAF2E" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
            <span>
              Отлично! Сфокусируемся на {selectedCount === 1 ? 'этой цели' : 'этих двух целях'}.
            </span>
          </div>
        )}
        <PrimaryButton onClick={handleNext} disabled={!canProceed}>
          Продолжить
        </PrimaryButton>
      </div>
    </Page>
  )
}

export default Welcome
